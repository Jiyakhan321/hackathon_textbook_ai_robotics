"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[5248],{7950:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>_,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"module-1-robotic-nervous-system/practical-exercises/exercise-2-robot-control-service","title":"Exercise 2: Robot Control Service for Humanoid Robot","description":"Overview","source":"@site/docs/module-1-robotic-nervous-system/practical-exercises/exercise-2-robot-control-service.md","sourceDirName":"module-1-robotic-nervous-system/practical-exercises","slug":"/module-1-robotic-nervous-system/practical-exercises/exercise-2-robot-control-service","permalink":"/hackathon_textbook_ai_robotics/docs/module-1-robotic-nervous-system/practical-exercises/exercise-2-robot-control-service","draft":false,"unlisted":false,"editUrl":"https://github.com/Jiyakhan321/hackathon_textbook_ai_robotics/tree/main/docs/module-1-robotic-nervous-system/practical-exercises/exercise-2-robot-control-service.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Exercise 1: Simple Publisher Node for Humanoid Robot","permalink":"/hackathon_textbook_ai_robotics/docs/module-1-robotic-nervous-system/practical-exercises/exercise-1-simple-publisher"},"next":{"title":"Exercise 3: Creating a Complete Humanoid Robot URDF","permalink":"/hackathon_textbook_ai_robotics/docs/module-1-robotic-nervous-system/practical-exercises/exercise-3-urdf-robot"}}');var i=s(4848),o=s(8453);const r={sidebar_position:2},l="Exercise 2: Robot Control Service for Humanoid Robot",a={},c=[{value:"Overview",id:"overview",level:2},{value:"Learning Objectives",id:"learning-objectives",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Step 1: Creating Custom Service Definitions",id:"step-1-creating-custom-service-definitions",level:2},{value:"Step 2: Creating the Service Server",id:"step-2-creating-the-service-server",level:2},{value:"Step 3: Creating the Service Client",id:"step-3-creating-the-service-client",level:2},{value:"Step 4: Creating a Command-Line Interface Client",id:"step-4-creating-a-command-line-interface-client",level:2},{value:"Step 5: Updating setup.py",id:"step-5-updating-setuppy",level:2},{value:"Step 6: Building and Running",id:"step-6-building-and-running",level:2},{value:"Step 7: Running the Service Server and Client",id:"step-7-running-the-service-server-and-client",level:2},{value:"Step 8: Testing the Services",id:"step-8-testing-the-services",level:2},{value:"Step 9: Adding Error Handling and Validation",id:"step-9-adding-error-handling-and-validation",level:2},{value:"Step 10: Adding the Robust Server to setup.py",id:"step-10-adding-the-robust-server-to-setuppy",level:2},{value:"Troubleshooting Tips",id:"troubleshooting-tips",level:2},{value:"Next Steps",id:"next-steps",level:2}];function m(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"exercise-2-robot-control-service-for-humanoid-robot",children:"Exercise 2: Robot Control Service for Humanoid Robot"})}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"In this exercise, you'll create a ROS 2 service server and client that allows for remote control of a humanoid robot. Services provide a request-response communication pattern, which is ideal for control commands that require confirmation of completion."}),"\n",(0,i.jsx)(n.h2,{id:"learning-objectives",children:"Learning Objectives"}),"\n",(0,i.jsx)(n.p,{children:"By completing this exercise, you will:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Create a custom service definition for robot control"}),"\n",(0,i.jsx)(n.li,{children:"Implement a service server that can control humanoid robot joints"}),"\n",(0,i.jsx)(n.li,{children:"Create a service client to send control commands"}),"\n",(0,i.jsx)(n.li,{children:"Understand the request-response pattern in ROS 2"}),"\n",(0,i.jsx)(n.li,{children:"Practice error handling in service implementations"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsx)(n.p,{children:"Before starting this exercise, ensure you have:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"ROS 2 Humble Hawksbill installed"}),"\n",(0,i.jsx)(n.li,{children:"Basic Python programming knowledge"}),"\n",(0,i.jsx)(n.li,{children:"Understanding of ROS 2 services and message definitions"}),"\n",(0,i.jsx)(n.li,{children:"Completion of Exercise 1 (or basic understanding of publishers)"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"step-1-creating-custom-service-definitions",children:"Step 1: Creating Custom Service Definitions"}),"\n",(0,i.jsx)(n.p,{children:"First, let's create custom service definitions for humanoid robot control. Create the service definition files:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# In your package directory\nmkdir -p humanoid_publisher_examples/srv\n"})}),"\n",(0,i.jsx)(n.p,{children:"Create the service definition file for setting joint positions:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# humanoid_publisher_examples/srv/SetJointPositions.srv\n# Request\nstring[] joint_names\nfloat64[] positions\nfloat64 duration  # Time to reach target position in seconds\n\n---\n# Response\nbool success\nstring message\nfloat64[] achieved_positions\n"})}),"\n",(0,i.jsx)(n.p,{children:"Create another service for executing predefined movements:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# humanoid_publisher_examples/srv/ExecuteMovement.srv\n# Request\nstring movement_type  # Options: 'wave', 'walk', 'sit', 'stand', 'dance'\nfloat64 speed         # Speed multiplier (0.1 to 2.0)\n\n---\n# Response\nbool success\nstring message\nstring executed_movement\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-2-creating-the-service-server",children:"Step 2: Creating the Service Server"}),"\n",(0,i.jsx)(n.p,{children:"Create the service server that will handle robot control requests:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# humanoid_publisher_examples/joint_control_server.py\n\nimport rclpy\nfrom rclpy.node import Node\nfrom sensor_msgs.msg import JointState\nimport time\nimport math\n\n# Import your custom service types (you'll need to generate them first)\n# For now, we'll use a mock implementation\ntry:\n    from humanoid_publisher_examples.srv import SetJointPositions, ExecuteMovement\nexcept ImportError:\n    # Mock service definitions for this example\n    class SetJointPositions:\n        class Request:\n            def __init__(self):\n                self.joint_names = []\n                self.positions = []\n                self.duration = 0.0\n\n        class Response:\n            def __init__(self):\n                self.success = False\n                self.message = \"\"\n                self.achieved_positions = []\n\n    class ExecuteMovement:\n        class Request:\n            def __init__(self):\n                self.movement_type = \"\"\n                self.speed = 1.0\n\n        class Response:\n            def __init__(self):\n                self.success = False\n                self.message = \"\"\n                self.executed_movement = \"\"\n\nclass JointControlServer(Node):\n    def __init__(self):\n        super().__init__('joint_control_server')\n\n        # Create publishers and services\n        self.joint_publisher = self.create_publisher(JointState, 'joint_states', 10)\n\n        # Create services\n        self.set_positions_service = self.create_service(\n            SetJointPositions,\n            'set_joint_positions',\n            self.handle_set_positions\n        )\n\n        self.execute_movement_service = self.create_service(\n            ExecuteMovement,\n            'execute_movement',\n            self.handle_execute_movement\n        )\n\n        # Initialize robot state\n        self.current_joint_names = [\n            'left_hip_joint', 'left_knee_joint', 'left_ankle_joint',\n            'right_hip_joint', 'right_knee_joint', 'right_ankle_joint',\n            'left_shoulder_joint', 'left_elbow_joint',\n            'right_shoulder_joint', 'right_elbow_joint'\n        ]\n\n        self.current_positions = [0.0] * len(self.current_joint_names)\n        self.target_positions = [0.0] * len(self.current_joint_names)\n        self.moving = False\n\n        # Timer for smooth joint movement\n        self.movement_timer = self.create_timer(0.02, self.movement_callback)  # 50 Hz\n\n        self.get_logger().info('Joint Control Server initialized')\n\n    def handle_set_positions(self, request, response):\n        \"\"\"Handle set joint positions request\"\"\"\n        self.get_logger().info(f'Received request to set {len(request.joint_names)} joint positions')\n\n        try:\n            # Validate request\n            if len(request.joint_names) != len(request.positions):\n                response.success = False\n                response.message = 'Joint names and positions arrays must have the same length'\n                return response\n\n            if request.duration <= 0:\n                response.success = False\n                response.message = 'Duration must be positive'\n                return response\n\n            # Update target positions\n            for i, joint_name in enumerate(request.joint_names):\n                if joint_name in self.current_joint_names:\n                    idx = self.current_joint_names.index(joint_name)\n                    self.target_positions[idx] = request.positions[i]\n                else:\n                    response.success = False\n                    response.message = f'Joint {joint_name} not found in robot model'\n                    return response\n\n            # Start smooth movement\n            self.moving = True\n            self.movement_start_time = self.get_clock().now().nanoseconds * 1e-9\n            self.movement_duration = request.duration\n            self.movement_start_positions = self.current_positions.copy()\n\n            response.success = True\n            response.message = f'Starting movement for {len(request.joint_names)} joints'\n            response.achieved_positions = self.target_positions.copy()\n\n            self.get_logger().info(f'Successfully started movement: {response.message}')\n\n        except Exception as e:\n            response.success = False\n            response.message = f'Error processing request: {str(e)}'\n            self.get_logger().error(response.message)\n\n        return response\n\n    def handle_execute_movement(self, request, response):\n        \"\"\"Handle execute predefined movement request\"\"\"\n        self.get_logger().info(f'Received request to execute movement: {request.movement_type}')\n\n        try:\n            # Validate movement type\n            valid_movements = ['wave', 'walk', 'sit', 'stand', 'dance', 'idle']\n            if request.movement_type not in valid_movements:\n                response.success = False\n                response.message = f'Invalid movement type. Valid options: {valid_movements}'\n                return response\n\n            if request.speed < 0.1 or request.speed > 2.0:\n                response.success = False\n                response.message = 'Speed must be between 0.1 and 2.0'\n                return response\n\n            # Execute the movement pattern\n            success, message = self.execute_movement_pattern(request.movement_type, request.speed)\n\n            response.success = success\n            response.message = message\n            response.executed_movement = request.movement_type\n\n            self.get_logger().info(f'Movement execution result: {message}')\n\n        except Exception as e:\n            response.success = False\n            response.message = f'Error executing movement: {str(e)}'\n            self.get_logger().error(response.message)\n\n        return response\n\n    def execute_movement_pattern(self, movement_type, speed):\n        \"\"\"Execute predefined movement patterns\"\"\"\n        try:\n            if movement_type == 'wave':\n                # Set positions for waving motion\n                self.target_positions[self.current_joint_names.index('right_shoulder_joint')] = 1.0\n                self.target_positions[self.current_joint_names.index('right_elbow_joint')] = 1.0\n                self.movement_duration = 2.0 / speed\n            elif movement_type == 'walk':\n                # Set positions for walking preparation\n                self.target_positions[self.current_joint_names.index('left_hip_joint')] = 0.2\n                self.target_positions[self.current_joint_names.index('right_hip_joint')] = 0.2\n                self.movement_duration = 1.0 / speed\n            elif movement_type == 'sit':\n                # Set positions for sitting\n                self.target_positions[self.current_joint_names.index('left_hip_joint')] = -1.0\n                self.target_positions[self.current_joint_names.index('left_knee_joint')] = 1.5\n                self.target_positions[self.current_joint_names.index('right_hip_joint')] = -1.0\n                self.target_positions[self.current_joint_names.index('right_knee_joint')] = 1.5\n                self.movement_duration = 3.0 / speed\n            elif movement_type == 'stand':\n                # Return to standing position\n                for i in range(len(self.target_positions)):\n                    self.target_positions[i] = 0.0\n                self.movement_duration = 2.0 / speed\n            elif movement_type == 'dance':\n                # Set positions for a simple dance move\n                self.target_positions[self.current_joint_names.index('left_shoulder_joint')] = 1.0\n                self.target_positions[self.current_joint_names.index('right_shoulder_joint')] = 1.0\n                self.target_positions[self.current_joint_names.index('left_hip_joint')] = 0.3\n                self.target_positions[self.current_joint_names.index('right_hip_joint')] = -0.3\n                self.movement_duration = 4.0 / speed\n            elif movement_type == 'idle':\n                # Return to neutral position\n                for i in range(len(self.target_positions)):\n                    self.target_positions[i] = 0.0\n                self.movement_duration = 1.0 / speed\n\n            # Start the movement\n            self.moving = True\n            self.movement_start_time = self.get_clock().now().nanoseconds * 1e-9\n            self.movement_start_positions = self.current_positions.copy()\n\n            return True, f'Started {movement_type} movement with speed {speed}'\n\n        except ValueError as e:\n            return False, f'Joint not found: {str(e)}'\n        except Exception as e:\n            return False, f'Error in movement pattern: {str(e)}'\n\n    def movement_callback(self):\n        \"\"\"Timer callback to smoothly move joints to target positions\"\"\"\n        if not self.moving:\n            # Publish current positions if not moving\n            self.publish_joint_states()\n            return\n\n        # Calculate movement progress\n        current_time = self.get_clock().now().nanoseconds * 1e-9\n        elapsed = current_time - self.movement_start_time\n\n        if elapsed >= self.movement_duration:\n            # Movement complete\n            self.current_positions = self.target_positions.copy()\n            self.moving = False\n            self.get_logger().info('Movement completed')\n        else:\n            # Interpolate between start and target positions\n            progress = elapsed / self.movement_duration\n            # Use smooth interpolation (ease-in-out)\n            smooth_progress = 0.5 * (1 - math.cos(math.pi * progress))\n\n            for i in range(len(self.current_positions)):\n                self.current_positions[i] = (\n                    self.movement_start_positions[i] +\n                    smooth_progress * (self.target_positions[i] - self.movement_start_positions[i])\n                )\n\n        # Publish current joint states\n        self.publish_joint_states()\n\n    def publish_joint_states(self):\n        \"\"\"Publish the current joint states\"\"\"\n        msg = JointState()\n        msg.header.stamp = self.get_clock().now().to_msg()\n        msg.header.frame_id = 'base_link'\n        msg.name = self.current_joint_names\n        msg.position = self.current_positions\n        msg.velocity = [0.0] * len(self.current_joint_names)\n        msg.effort = [0.0] * len(self.current_joint_names)\n\n        self.joint_publisher.publish(msg)\n\ndef main(args=None):\n    \"\"\"Main function to initialize and run the server\"\"\"\n    rclpy.init(args=args)\n\n    try:\n        control_server = JointControlServer()\n        control_server.get_logger().info('Starting joint control server...')\n\n        rclpy.spin(control_server)\n\n    except KeyboardInterrupt:\n        print('\\nShutting down joint control server...')\n    finally:\n        control_server.destroy_node()\n        rclpy.shutdown()\n\nif __name__ == '__main__':\n    main()\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-3-creating-the-service-client",children:"Step 3: Creating the Service Client"}),"\n",(0,i.jsx)(n.p,{children:"Create a client that can call the services:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# humanoid_publisher_examples/joint_control_client.py\n\nimport rclpy\nfrom rclpy.node import Node\nimport time\n\n# Import your custom service types\ntry:\n    from humanoid_publisher_examples.srv import SetJointPositions, ExecuteMovement\nexcept ImportError:\n    # Mock service definitions for this example\n    class SetJointPositions:\n        class Request:\n            def __init__(self):\n                self.joint_names = []\n                self.positions = []\n                self.duration = 0.0\n\n        class Response:\n            def __init__(self):\n                self.success = False\n                self.message = \"\"\n                self.achieved_positions = []\n\n    class ExecuteMovement:\n        class Request:\n            def __init__(self):\n                self.movement_type = \"\"\n                self.speed = 1.0\n\n        class Response:\n            def __init__(self):\n                self.success = False\n                self.message = \"\"\n                self.executed_movement = \"\"\n\nclass JointControlClient(Node):\n    def __init__(self):\n        super().__init__('joint_control_client')\n\n        # Create clients for the services\n        self.set_positions_client = self.create_client(\n            SetJointPositions,\n            'set_joint_positions'\n        )\n\n        self.execute_movement_client = self.create_client(\n            ExecuteMovement,\n            'execute_movement'\n        )\n\n        # Wait for services to be available\n        while not self.set_positions_client.wait_for_service(timeout_sec=1.0):\n            self.get_logger().info('Set positions service not available, waiting again...')\n\n        while not self.execute_movement_client.wait_for_service(timeout_sec=1.0):\n            self.get_logger().info('Execute movement service not available, waiting again...')\n\n        self.get_logger().info('Joint Control Client initialized and services available')\n\n    def set_joint_positions(self, joint_names, positions, duration=2.0):\n        \"\"\"Send a request to set specific joint positions\"\"\"\n        request = SetJointPositions.Request()\n        request.joint_names = joint_names\n        request.positions = positions\n        request.duration = duration\n\n        self.get_logger().info(f'Sending set positions request for {len(joint_names)} joints')\n\n        # Make the service call\n        future = self.set_positions_client.call_async(request)\n        rclpy.spin_until_future_complete(self, future)\n\n        response = future.result()\n        if response:\n            if response.success:\n                self.get_logger().info(f'Successfully set joint positions: {response.message}')\n                self.get_logger().info(f'Achieved positions: {response.achieved_positions}')\n            else:\n                self.get_logger().error(f'Failed to set joint positions: {response.message}')\n        else:\n            self.get_logger().error('Service call failed')\n\n        return response\n\n    def execute_movement(self, movement_type, speed=1.0):\n        \"\"\"Send a request to execute a predefined movement\"\"\"\n        request = ExecuteMovement.Request()\n        request.movement_type = movement_type\n        request.speed = speed\n\n        self.get_logger().info(f'Sending execute movement request: {movement_type} at speed {speed}')\n\n        # Make the service call\n        future = self.execute_movement_client.call_async(request)\n        rclpy.spin_until_future_complete(self, future)\n\n        response = future.result()\n        if response:\n            if response.success:\n                self.get_logger().info(f'Successfully executed movement: {response.executed_movement}')\n                self.get_logger().info(f'Result: {response.message}')\n            else:\n                self.get_logger().error(f'Failed to execute movement: {response.message}')\n        else:\n            self.get_logger().error('Service call failed')\n\n        return response\n\n    def demo_sequence(self):\n        \"\"\"Run a demonstration sequence of control commands\"\"\"\n        self.get_logger().info('Starting demonstration sequence...')\n\n        # 1. Move to standing position\n        self.get_logger().info('Moving to standing position...')\n        self.execute_movement('stand', speed=1.0)\n        time.sleep(3)\n\n        # 2. Wave with right arm\n        self.get_logger().info('Waving with right arm...')\n        self.execute_movement('wave', speed=1.0)\n        time.sleep(3)\n\n        # 3. Prepare to walk\n        self.get_logger().info('Preparing to walk...')\n        self.execute_movement('walk', speed=1.0)\n        time.sleep(2)\n\n        # 4. Sit down\n        self.get_logger().info('Sitting down...')\n        self.execute_movement('sit', speed=0.8)\n        time.sleep(4)\n\n        # 5. Stand up\n        self.get_logger().info('Standing up...')\n        self.execute_movement('stand', speed=1.0)\n        time.sleep(3)\n\n        # 6. Do a little dance\n        self.get_logger().info('Dancing...')\n        self.execute_movement('dance', speed=1.2)\n        time.sleep(5)\n\n        # 7. Return to idle\n        self.get_logger().info('Returning to idle position...')\n        self.execute_movement('idle', speed=1.0)\n\n        self.get_logger().info('Demonstration sequence completed!')\n\ndef main(args=None):\n    \"\"\"Main function to initialize and run the client\"\"\"\n    rclpy.init(args=args)\n\n    try:\n        client = JointControlClient()\n\n        # Run the demonstration sequence\n        client.demo_sequence()\n\n    except KeyboardInterrupt:\n        print('\\nClient interrupted by user')\n    finally:\n        client.destroy_node()\n        rclpy.shutdown()\n\nif __name__ == '__main__':\n    main()\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-4-creating-a-command-line-interface-client",children:"Step 4: Creating a Command-Line Interface Client"}),"\n",(0,i.jsx)(n.p,{children:"Create a more interactive client that allows manual control:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# humanoid_publisher_examples/manual_control_client.py\n\nimport rclpy\nfrom rclpy.node import Node\nimport sys\nimport select\nimport tty\nimport termios\n\ntry:\n    from humanoid_publisher_examples.srv import SetJointPositions, ExecuteMovement\nexcept ImportError:\n    # Mock service definitions for this example\n    class SetJointPositions:\n        class Request:\n            def __init__(self):\n                self.joint_names = []\n                self.positions = []\n                self.duration = 0.0\n\n        class Response:\n            def __init__(self):\n                self.success = False\n                self.message = ""\n                self.achieved_positions = []\n\n    class ExecuteMovement:\n        class Request:\n            def __init__(self):\n                self.movement_type = ""\n                self.speed = 1.0\n\n        class Response:\n            def __init__(self):\n                self.success = False\n                self.message = ""\n                self.executed_movement = ""\n\nclass ManualControlClient(Node):\n    def __init__(self):\n        super().__init__(\'manual_control_client\')\n\n        # Create clients for the services\n        self.set_positions_client = self.create_client(\n            SetJointPositions,\n            \'set_joint_positions\'\n        )\n\n        self.execute_movement_client = self.create_client(\n            ExecuteMovement,\n            \'execute_movement\'\n        )\n\n        # Wait for services to be available\n        while not self.set_positions_client.wait_for_service(timeout_sec=1.0):\n            self.get_logger().info(\'Set positions service not available, waiting again...\')\n\n        while not self.execute_movement_client.wait_for_service(timeout_sec=1.0):\n            self.get_logger().info(\'Execute movement service not available, waiting again...\')\n\n        self.get_logger().info(\'Manual Control Client initialized\')\n        self.print_usage()\n\n    def print_usage(self):\n        """Print usage instructions"""\n        print("\\n" + "="*60)\n        print("HUMANOID ROBOT MANUAL CONTROL INTERFACE")\n        print("="*60)\n        print("Commands:")\n        print("  w - Wave (right arm)")\n        print("  W - Walk preparation")\n        print("  s - Sit down")\n        print("  S - Stand up")\n        print("  d - Dance")\n        print("  i - Idle position")\n        print("  m - Move specific joints")\n        print("  q - Quit")\n        print("\\nPress any command key to execute...")\n\n    def execute_movement(self, movement_type, speed=1.0):\n        """Execute a predefined movement"""\n        request = ExecuteMovement.Request()\n        request.movement_type = movement_type\n        request.speed = speed\n\n        future = self.execute_movement_client.call_async(request)\n        rclpy.spin_until_future_complete(self, future)\n\n        response = future.result()\n        if response and response.success:\n            self.get_logger().info(f\'\u2713 {movement_type.capitalize()} movement executed\')\n        else:\n            error_msg = response.message if response else "Service call failed"\n            self.get_logger().error(f\'\u2717 Failed to execute {movement_type}: {error_msg}\')\n\n    def move_specific_joints(self):\n        """Move specific joints to custom positions"""\n        print("\\nMoving specific joints...")\n        print("Available joints: left/right_hip, left/right_knee, left/right_ankle, left/right_shoulder, left/right_elbow")\n\n        try:\n            joint_name = input("Enter joint name: ").strip()\n            position = float(input("Enter position (in radians): "))\n            duration = float(input("Enter duration (in seconds, default 2.0): ") or "2.0")\n\n            request = SetJointPositions.Request()\n            request.joint_names = [joint_name]\n            request.positions = [position]\n            request.duration = duration\n\n            future = self.set_positions_client.call_async(request)\n            rclpy.spin_until_future_complete(self, future)\n\n            response = future.result()\n            if response and response.success:\n                self.get_logger().info(f\'\u2713 Moved {joint_name} to {position} radians\')\n            else:\n                error_msg = response.message if response else "Service call failed"\n                self.get_logger().error(f\'\u2717 Failed to move joint: {error_msg}\')\n\n        except ValueError:\n            self.get_logger().error("Invalid input. Please enter numeric values for position and duration.")\n        except KeyboardInterrupt:\n            print("\\nJoint movement cancelled.")\n\n    def run_interactive(self):\n        """Run the interactive control loop"""\n        old_settings = termios.tcgetattr(sys.stdin)\n        try:\n            tty.setraw(sys.stdin.fileno())\n\n            while True:\n                if select.select([sys.stdin], [], [], 0.1)[0]:\n                    key = sys.stdin.read(1)\n\n                    if key.lower() == \'q\':\n                        print("\\nQuitting...")\n                        break\n                    elif key.lower() == \'w\':\n                        self.execute_movement(\'wave\')\n                    elif key.lower() == \'w\' and key.isupper():  # Shift+W\n                        self.execute_movement(\'walk\')\n                    elif key.lower() == \'s\' and key.islower():  # s for sit\n                        self.execute_movement(\'sit\')\n                    elif key.lower() == \'s\' and key.isupper():  # S for stand\n                        self.execute_movement(\'stand\')\n                    elif key.lower() == \'d\':\n                        self.execute_movement(\'dance\')\n                    elif key.lower() == \'i\':\n                        self.execute_movement(\'idle\')\n                    elif key.lower() == \'m\':\n                        self.move_specific_joints()\n                    else:\n                        print(f"\\nUnknown command: {key}. Press \'?\' for help.")\n                        self.print_usage()\n\n        finally:\n            termios.tcsetattr(sys.stdin, termios.TCSADRAIN, old_settings)\n\ndef main(args=None):\n    """Main function to initialize and run the manual client"""\n    rclpy.init(args=args)\n\n    try:\n        client = ManualControlClient()\n        client.run_interactive()\n\n    except KeyboardInterrupt:\n        print(\'\\nManual control interrupted by user\')\n    finally:\n        client.destroy_node()\n        rclpy.shutdown()\n\nif __name__ == \'__main__\':\n    main()\n'})}),"\n",(0,i.jsx)(n.h2,{id:"step-5-updating-setuppy",children:"Step 5: Updating setup.py"}),"\n",(0,i.jsxs)(n.p,{children:["Add the new executables to your ",(0,i.jsx)(n.code,{children:"setup.py"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Add to entry_points in setup.py\nentry_points={\n    'console_scripts': [\n        'simple_joint_publisher = humanoid_publisher_examples.simple_joint_publisher:main',\n        'enhanced_joint_publisher = humanoid_publisher_examples.enhanced_joint_publisher:main',\n        'joint_control_server = humanoid_publisher_examples.joint_control_server:main',\n        'joint_control_client = humanoid_publisher_examples.joint_control_client:main',\n        'manual_control_client = humanoid_publisher_examples.manual_control_client:main',\n    ],\n},\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-6-building-and-running",children:"Step 6: Building and Running"}),"\n",(0,i.jsx)(n.p,{children:"Build your package:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cd ~/humanoid_ws\ncolcon build --packages-select humanoid_publisher_examples\nsource install/setup.bash\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-7-running-the-service-server-and-client",children:"Step 7: Running the Service Server and Client"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Start the server"})," (in one terminal):"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"ros2 run humanoid_publisher_examples joint_control_server\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Run the demo client"})," (in another terminal):"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"ros2 run humanoid_publisher_examples joint_control_client\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Or run the manual client"})," (in another terminal):"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"ros2 run humanoid_publisher_examples manual_control_client\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-8-testing-the-services",children:"Step 8: Testing the Services"}),"\n",(0,i.jsx)(n.p,{children:"You can also test the services using the command line:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Test set_joint_positions service\nros2 service call /set_joint_positions humanoid_publisher_examples/srv/SetJointPositions \"{\n  joint_names: ['left_shoulder_joint', 'right_shoulder_joint'],\n  positions: [0.5, 0.5],\n  duration: 2.0\n}\"\n\n# Test execute_movement service\nros2 service call /execute_movement humanoid_publisher_examples/srv/ExecuteMovement \"{\n  movement_type: 'wave',\n  speed: 1.0\n}\"\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-9-adding-error-handling-and-validation",children:"Step 9: Adding Error Handling and Validation"}),"\n",(0,i.jsx)(n.p,{children:"Enhance the server with better error handling:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# humanoid_publisher_examples/robust_control_server.py\n\nimport rclpy\nfrom rclpy.node import Node\nfrom sensor_msgs.msg import JointState\nimport time\nimport math\nfrom threading import Lock\n\ntry:\n    from humanoid_publisher_examples.srv import SetJointPositions, ExecuteMovement\nexcept ImportError:\n    # Mock service definitions\n    class SetJointPositions:\n        class Request:\n            def __init__(self):\n                self.joint_names = []\n                self.positions = []\n                self.duration = 0.0\n\n        class Response:\n            def __init__(self):\n                self.success = False\n                self.message = \"\"\n                self.achieved_positions = []\n\n    class ExecuteMovement:\n        class Request:\n            def __init__(self):\n                self.movement_type = \"\"\n                self.speed = 1.0\n\n        class Response:\n            def __init__(self):\n                self.success = False\n                self.message = \"\"\n                self.executed_movement = \"\"\n\nclass RobustControlServer(Node):\n    def __init__(self):\n        super().__init__('robust_control_server')\n\n        # Thread safety lock\n        self.lock = Lock()\n\n        # Create publishers and services\n        self.joint_publisher = self.create_publisher(JointState, 'joint_states', 10)\n\n        self.set_positions_service = self.create_service(\n            SetJointPositions,\n            'set_joint_positions',\n            self.handle_set_positions\n        )\n\n        self.execute_movement_service = self.create_service(\n            ExecuteMovement,\n            'execute_movement',\n            self.handle_execute_movement\n        )\n\n        # Initialize robot state\n        self.current_joint_names = [\n            'left_hip_joint', 'left_knee_joint', 'left_ankle_joint',\n            'right_hip_joint', 'right_knee_joint', 'right_ankle_joint',\n            'left_shoulder_joint', 'left_elbow_joint',\n            'right_shoulder_joint', 'right_elbow_joint'\n        ]\n\n        self.current_positions = [0.0] * len(self.current_joint_names)\n        self.target_positions = [0.0] * len(self.current_joint_names)\n        self.moving = False\n        self.active_movement = None\n\n        # Timer for smooth joint movement\n        self.movement_timer = self.create_timer(0.02, self.movement_callback)\n\n        self.get_logger().info('Robust Control Server initialized')\n\n    def handle_set_positions(self, request, response):\n        \"\"\"Handle set joint positions request with enhanced validation\"\"\"\n        with self.lock:\n            self.get_logger().info(f'Received request to set {len(request.joint_names)} joint positions')\n\n            try:\n                # Input validation\n                if not request.joint_names or not request.positions:\n                    response.success = False\n                    response.message = 'Joint names and positions cannot be empty'\n                    return response\n\n                if len(request.joint_names) != len(request.positions):\n                    response.success = False\n                    response.message = f'Length mismatch: {len(request.joint_names)} names vs {len(request.positions)} positions'\n                    return response\n\n                if request.duration <= 0:\n                    response.success = False\n                    response.message = 'Duration must be positive'\n                    return response\n\n                if request.duration > 10.0:  # Maximum 10 seconds for safety\n                    response.success = False\n                    response.message = 'Duration cannot exceed 10 seconds for safety'\n                    return response\n\n                # Validate joint names and positions\n                for i, joint_name in enumerate(request.joint_names):\n                    if joint_name not in self.current_joint_names:\n                        response.success = False\n                        response.message = f'Invalid joint name: {joint_name}'\n                        return response\n\n                    # Validate position limits (example: -3.14 to 3.14 radians)\n                    if abs(request.positions[i]) > 3.14:\n                        response.success = False\n                        response.message = f'Position out of range for {joint_name}: {request.positions[i]}'\n                        return response\n\n                # Update target positions\n                for i, joint_name in enumerate(request.joint_names):\n                    idx = self.current_joint_names.index(joint_name)\n                    self.target_positions[idx] = request.positions[i]\n\n                # Start smooth movement\n                self.moving = True\n                self.active_movement = 'custom'\n                self.movement_start_time = self.get_clock().now().nanoseconds * 1e-9\n                self.movement_duration = request.duration\n                self.movement_start_positions = self.current_positions.copy()\n\n                response.success = True\n                response.message = f'Successfully started movement for {len(request.joint_names)} joints'\n                response.achieved_positions = self.target_positions.copy()\n\n                self.get_logger().info(f'Movement started: {response.message}')\n\n            except Exception as e:\n                response.success = False\n                response.message = f'Unexpected error: {str(e)}'\n                self.get_logger().error(f'Service error: {response.message}')\n                self.get_logger().error(f'Error details: {type(e).__name__}: {e}')\n\n            return response\n\n    def handle_execute_movement(self, request, response):\n        \"\"\"Handle execute predefined movement with enhanced validation\"\"\"\n        with self.lock:\n            self.get_logger().info(f'Received request to execute movement: {request.movement_type}')\n\n            try:\n                # Validate input\n                valid_movements = ['wave', 'walk', 'sit', 'stand', 'dance', 'idle', 'rest']\n                if request.movement_type not in valid_movements:\n                    response.success = False\n                    response.message = f'Invalid movement type. Valid options: {valid_movements}'\n                    return response\n\n                if request.speed < 0.1 or request.speed > 3.0:\n                    response.success = False\n                    response.message = 'Speed must be between 0.1 and 3.0'\n                    return response\n\n                # Execute the movement pattern\n                success, message = self.execute_movement_pattern(request.movement_type, request.speed)\n\n                response.success = success\n                response.message = message\n                response.executed_movement = request.movement_type\n\n                if success:\n                    self.get_logger().info(f'Movement executed: {message}')\n                else:\n                    self.get_logger().error(f'Movement failed: {message}')\n\n            except Exception as e:\n                response.success = False\n                response.message = f'Unexpected error in movement execution: {str(e)}'\n                self.get_logger().error(f'Service error: {response.message}')\n\n            return response\n\n    def execute_movement_pattern(self, movement_type, speed):\n        \"\"\"Execute predefined movement patterns with safety checks\"\"\"\n        try:\n            # Define safe limits for each movement type\n            if movement_type == 'wave':\n                self.target_positions[self.current_joint_names.index('right_shoulder_joint')] = 1.0\n                self.target_positions[self.current_joint_names.index('right_elbow_joint')] = 1.0\n                self.movement_duration = 2.0 / speed\n            elif movement_type == 'walk':\n                self.target_positions[self.current_joint_names.index('left_hip_joint')] = 0.2\n                self.target_positions[self.current_joint_names.index('right_hip_joint')] = 0.2\n                self.movement_duration = 1.0 / speed\n            elif movement_type == 'sit':\n                # Safe sitting position\n                self.target_positions[self.current_joint_names.index('left_hip_joint')] = -1.0\n                self.target_positions[self.current_joint_names.index('left_knee_joint')] = 1.5\n                self.target_positions[self.current_joint_names.index('right_hip_joint')] = -1.0\n                self.target_positions[self.current_joint_names.index('right_knee_joint')] = 1.5\n                self.movement_duration = 3.0 / speed\n            elif movement_type == 'stand':\n                # Return to neutral standing position\n                for i in range(len(self.target_positions)):\n                    self.target_positions[i] = 0.0\n                self.movement_duration = 2.0 / speed\n            elif movement_type == 'dance':\n                # Safe dance position\n                self.target_positions[self.current_joint_names.index('left_shoulder_joint')] = 0.8\n                self.target_positions[self.current_joint_names.index('right_shoulder_joint')] = 0.8\n                self.target_positions[self.current_joint_names.index('left_hip_joint')] = 0.2\n                self.target_positions[self.current_joint_names.index('right_hip_joint')] = -0.2\n                self.movement_duration = 4.0 / speed\n            elif movement_type == 'idle' or movement_type == 'rest':\n                # Return to safe rest position\n                for i in range(len(self.target_positions)):\n                    self.target_positions[i] = 0.0\n                self.movement_duration = 1.0 / speed\n\n            # Start the movement\n            self.moving = True\n            self.active_movement = movement_type\n            self.movement_start_time = self.get_clock().now().nanoseconds * 1e-9\n            self.movement_start_positions = self.current_positions.copy()\n\n            return True, f'Started {movement_type} movement with speed {speed}'\n\n        except ValueError as e:\n            return False, f'Joint not found in robot model: {str(e)}'\n        except Exception as e:\n            return False, f'Error in movement pattern execution: {str(e)}'\n\n    def movement_callback(self):\n        \"\"\"Timer callback to smoothly move joints with safety checks\"\"\"\n        with self.lock:\n            if not self.moving:\n                # Publish current positions if not moving\n                self.publish_joint_states()\n                return\n\n            # Calculate movement progress\n            current_time = self.get_clock().now().nanoseconds * 1e-9\n            elapsed = current_time - self.movement_start_time\n\n            if elapsed >= self.movement_duration:\n                # Movement complete\n                self.current_positions = self.target_positions.copy()\n                self.moving = False\n                self.active_movement = None\n                self.get_logger().info('Movement completed successfully')\n            else:\n                # Interpolate between start and target positions with smooth easing\n                progress = min(elapsed / self.movement_duration, 1.0)  # Clamp to [0, 1]\n                # Use smooth step function for natural movement\n                smooth_progress = progress * progress * (3 - 2 * progress)\n\n                for i in range(len(self.current_positions)):\n                    self.current_positions[i] = (\n                        self.movement_start_positions[i] +\n                        smooth_progress * (self.target_positions[i] - self.movement_start_positions[i])\n                    )\n\n            # Publish current joint states\n            self.publish_joint_states()\n\n    def publish_joint_states(self):\n        \"\"\"Publish the current joint states\"\"\"\n        msg = JointState()\n        msg.header.stamp = self.get_clock().now().to_msg()\n        msg.header.frame_id = 'base_link'\n        msg.name = self.current_joint_names\n        msg.position = self.current_positions.copy()\n        msg.velocity = [0.0] * len(self.current_joint_names)\n        msg.effort = [0.0] * len(self.current_joint_names)\n\n        self.joint_publisher.publish(msg)\n\ndef main(args=None):\n    \"\"\"Main function to initialize and run the robust server\"\"\"\n    rclpy.init(args=args)\n\n    try:\n        control_server = RobustControlServer()\n        control_server.get_logger().info('Starting robust joint control server...')\n\n        rclpy.spin(control_server)\n\n    except KeyboardInterrupt:\n        print('\\nShutting down robust control server...')\n    finally:\n        control_server.destroy_node()\n        rclpy.shutdown()\n\nif __name__ == '__main__':\n    main()\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-10-adding-the-robust-server-to-setuppy",children:"Step 10: Adding the Robust Server to setup.py"}),"\n",(0,i.jsxs)(n.p,{children:["Add the robust server to your ",(0,i.jsx)(n.code,{children:"setup.py"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Add to entry_points in setup.py\nentry_points={\n    'console_scripts': [\n        'simple_joint_publisher = humanoid_publisher_examples.simple_joint_publisher:main',\n        'enhanced_joint_publisher = humanoid_publisher_examples.enhanced_joint_publisher:main',\n        'joint_control_server = humanoid_publisher_examples.joint_control_server:main',\n        'robust_control_server = humanoid_publisher_examples.robust_control_server:main',\n        'joint_control_client = humanoid_publisher_examples.joint_control_client:main',\n        'manual_control_client = humanoid_publisher_examples.manual_control_client:main',\n    ],\n},\n"})}),"\n",(0,i.jsx)(n.h2,{id:"troubleshooting-tips",children:"Troubleshooting Tips"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Service not found"}),": Make sure the server is running before calling the client"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Import errors"}),": If you created custom .srv files, make sure to build them properly"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Permission errors"}),": Check file permissions on your Python scripts"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Connection timeouts"}),": Verify that both nodes are on the same ROS domain"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,i.jsx)(n.p,{children:"After completing this exercise, you should have a solid understanding of:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Creating custom ROS 2 service definitions"}),"\n",(0,i.jsx)(n.li,{children:"Implementing service servers for robot control"}),"\n",(0,i.jsx)(n.li,{children:"Creating service clients to send commands"}),"\n",(0,i.jsx)(n.li,{children:"Handling errors and validation in services"}),"\n",(0,i.jsx)(n.li,{children:"Implementing smooth motion control for humanoid robots"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"In the next exercise, we'll explore creating URDF files for humanoid robots and integrating them with our control systems."})]})}function _(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(m,{...e})}):m(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>l});var t=s(6540);const i={},o=t.createContext(i);function r(e){const n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);